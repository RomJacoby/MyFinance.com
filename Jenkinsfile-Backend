def api_routes = ["get_all_stocks","get_all_indices"]
pipeline {
    environment{
        image_name = "myfinance_backend:${env.BUILD_ID}"
        container_id = ""
        dockerfile = "./app/Dockerfile-Backend"
        dockerfile_context = "./app/"
        abort = false 
    }

    agent any

    stages {
        stage('Build image for test') {
            when {
	            allOf {
                    branch 'feature'
                    expression {abort != true}
                }  
	        }
            steps {
                script {
                    docker.build("${image_name}" , "-f ${dockerfile} ${dockerfile_context}")
                    output = sh(script:"docker images ${image_name}",returnStdout:true)
                    image_built = output.contains("myfinance_backend")
                    if (image_built == false)
                    {
                        echo 'Could not build Backend image, ABORT pipeline'
                        abort = true
                        currentBuild.result = 'ABORTED'
                        error('Aborting...')
                    }
                }
            }
        }
        stage('Test') {
            when {
	            allOf {
                    branch 'feature'
                    expression {abort != true}
                }  
	        }
            steps {
                script {
                    container_id = sh(script:"docker run -d --rm -p 100:5000 ${image_name}",returnStdout:true)
                    container_status = sh(script:"docker inspect ${container_id}",returnStdout:true)
                    if (container_status.contains("running"))
                    {
                        sleep(5)
                        for (route in api_routes)
                        {
                            try
                            {
                                url = 'http://localhost:100/' + route
                                response = httpRequest url
                            } 
                            catch (Exception e)
                            {
                                echo "Could not send GET request to ${url}, ABORT pipeline"
                                abort = true
                                currentBuild.result = 'ABORTED'
                                error('Aborting...')
                            }
                        }
                    }
                    else
                    {
                        echo "Container failed to run, ABORT pipeline"
                        abort = true
                        currentBuild.result = 'ABORTED'
                        error('Aborting...')
                    }
                }
            }
        }
        stage('Push to Master') {
            when {
                allOf {
                    branch 'feature'
                    expression {abort != true}
                }
            }
            steps{
                withCredentials([usernamePassword(credentialsId: 'b09400db-9f0b-4de4-bb24-1f06515eb59a', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                            sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/RomJacoby/MyFinance.com HEAD:master'
                }
            }
        }
	    stage('Build image for deploy') {
            when {
                branch 'master'
            }
            steps {
                echo 'Building for deploy'
            }
        }
        stage('Deploy') {
            when {
                branch 'master'
            }
            steps {
                echo 'Deploying....'
            }
        }
        //add cleanup
    }
    post {
        always{
            script{
               if (env.BRANCH_NAME == 'feature')
               {
                   sh "docker kill ${container_id}"
                   sh "docker rmi -f ${image_name}"
               }
            }
        }
    }
}
